<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>JNIF: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">JNIF
   &#160;<span id="projectnumber">0.9</span>
   </div>
   <div id="projectbrief">Java Native Instrumentation Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">JNIF Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>JNIF is the first native Java bytecode rewriting library. JNIF is a C++ library for decoding, analyzing, editing, and encoding Java bytecode. The main benefit of JNIF is that it can be plugged into a JVMTI agent for instrumenting all classes in a JVM transparently, i.e., without connecting to another JVM and without perturbing the observed JVM. Besides, JNIF can be used in stand-alone tools as well.</p>
<p>JNIF includes a data-flow analysis for stack map generation, a complication necessary for any library that provides editing and encoding support for modern JVMs with split-time verification. It is written in C++11, in an object-oriented style similar to Java-based class rewriting APIs.</p>
<h1>Documentation</h1>
<p>The complete API documentation is available online at</p>
<p><a href="http://acuarica.bitbucket.org/jnif/docs/">http://acuarica.bitbucket.org/jnif/docs/</a></p>
<h1>Installation</h1>
<p>The JNIF library can be used as a static library which can be then linked with your project.</p>
<p>To compile JNIF it is enough to "make" the library </p>
<pre class="fragment">make
</pre><p>All sources of JNIF are contained in the "src" folder.</p>
<p>To use JNIF classes, the header file <b><a class="el" href="jnif_8hpp.html">jnif.hpp</a></b> must be included. </p>
<pre class="fragment">#include &lt;jnif.hpp&gt;
</pre><p>Make sure to add the <b>src</b> folder to the include search directories so your compiler can found JNIF's headers, i.e., with the **-I** compiler flag and then link your project against the <b>libjnif.a</b>.</p>
<h1>Getting started</h1>
<p>This section shows common use cases of the JNIF library, such as writing instrumentation code and analyzing class files, thus giving an overview of the library. We present the examples in an incremental fashion, adding complexity in each example.</p>
<p>In order to be able to work with class files, first they must me parsed. Given a memoery buffer with a class file and its length, the following snippet shows how to parse it. </p>
<pre class="fragment">const char* data = ...;
int len = ...;

jnif::ClassFile cf(data, len);
</pre><p>JNIF's <b>ClassFile</b> class provides fields and methods for analyzing and editing a Java class. It contains the definition of each method and field declared in the Java class.</p>
<p>Once a class file is correctly parsed and loaded it can be manipulated using the methods and fields in <b>ClassFile</b>. For instance, in order to write back the parsed class file in a new buffer, the write method is used in conjunction with the <b>computeSize</b> method as shown below. </p>
<pre class="fragment">const char* data = ...;
int len = ...;
jnif::ClassFile cf(data, len);
int newlen = cf.computeSize();
u1* newdata = new u1[newlen];
cf.write(newdata, newlen);

// Use newdata and newlen

delete [] newdata;
</pre><p>Putting all together, the following listing shows how to read and write a class file. </p>
<pre class="fragment">// Decode the binary data into a ClassFile object
const char* data = ...;
int len = ...;
jnif::ClassFile cf(data, len);

// Analyze or edit the ClassFile
...

// Encode the ClassFile into binary
int newlen = cf.computeSize();
u1* newdata = new u1[newlen];
cf.write(newdata, newlen);

// Use newdata and newlen
...

// Free the new binary
delete [] newdata;
</pre><p>The <b>ClassFile</b> class has a collection of fields and methods which can be used to discover the members of the class file. The snippet below shows how to traverse all methods in a class to dump their names and descriptors. Note that every <b>jnif</b> class overloads the <b>operator&lt;&lt;** in order send it to an **std::ostream</b>. </p>
<pre class="fragment">const char* data = ...;
int len = ...;
jnif::ClassFile cf(data, len);

for (jnif::Method* m : cf.methods) {
  cout &lt;&lt; "Method: ";
  cout &lt;&lt; cf.getUtf8(m-&gt;nameIndex);
  cout &lt;&lt; cf.getUtf8(m-&gt;descIndex);
  cout &lt;&lt; endl;
}
</pre><p>The following listing shows how to find all constructors (named **&lt;init&gt;** at Java bytecode level) in a class and how to inject instrumentation, in the form of a call to a static method <b>static void alloc(Object o)</b> of an analysis class, at the beginning of each constructor. </p>
<pre class="fragment">ConstIndex mid = cf.addMethodRef(classIndex, "alloc", "(Ljava/lang/Object;)V");

for (Method* method : cf.methods) {
  if (method-&gt;isInit()) {
    InstList&amp; instList = method-&gt;instList();

    Inst* p = *instList.begin();
    instList.addZero(OPCODE_aload_0, p);
    instList.addInvoke(OPCODE_invokestatic, mid, p);
  }
}
</pre><p>Another common use case is to instrument every method entry and exit. In order to do so, it is possible to add the instrumentation code at the beginning of the instruction list to detect the method entry. To detect method exit, it is necessary to look for instructions that terminate the current method execution, i.e., xRETURN family and ATHROW as showed in the following snippet. </p>
<pre class="fragment">ConstIndex sid = cf.addMethodRef(proxyClass, "enterMethod",
                "(Ljava/lang/String;Ljava/lang/String;)V");
ConstIndex eid = cf.addMethodRef(proxyClass, "exitMethod",
                "(Ljava/lang/String;Ljava/lang/String;)V");
ConstIndex classNameIdx = cf.addStringFromClass(cf.thisClassIndex);

...

InstList&amp; instList = method-&gt;instList();

ConstIndex methodIndex = cf.addString(m-&gt;nameIndex);

Inst* p = *instList.begin();

instList.addLdc(OPCODE_ldc_w, classNameIdx, p);
instList.addLdc(OPCODE_ldc_w, methodIndex, p);
instList.addInvoke(OPCODE_invokestatic, sid, p);

for (Inst* inst : instList) {
    if (inst-&gt;isExit()) {
        instList.addLdc(OPCODE_ldc_w, classNameIdx, inst);
        instList.addLdc(OPCODE_ldc_w, methodIndex, inst);
        instList.addInvoke(OPCODE_invokestatic, eid, inst);
    }
}
</pre><p>Besides providing access to all members of a class, <b>ClassFile</b> also provides access to the constant pool via methods like <b>getUtf8()</b> and <b>addMethodRef()</b>.</p>
<p>To run these evaluations, a Makefile script is provided in the git repository. These tasks take care of the compilation of the JNIF library and also all java files needed. The repository is self-contained, no need to download dacapo benchmarks separately.</p>
<p>{lstlisting}[caption=Running testapp,label=usage-parse2] </p>
<blockquote class="doxtable">
<p>make testapp</p>
<p></p>
</blockquote>
<p>{lstlisting}</p>
<p>{lstlisting}[caption=Running dacapo,label=usage-parse2] </p>
<blockquote class="doxtable">
<p>make testapp</p>
<p></p>
</blockquote>
<p>{lstlisting}</p>
<p>To run a particular dacapo benchmark with default settings</p>
<p>{lstlisting}[caption=Running dacapo,label=usage-parse2] </p>
<blockquote class="doxtable">
<p>make dacapo BENCH=avrora</p>
<p></p>
</blockquote>
<p>{lstlisting}</p>
<p>To run a full evaluation with all dacapo benchmarks in all configuration a task -eval- is provided. You can set how many times run each configuration with the variable times, like</p>
<p>{lstlisting}[caption=Running full eval five times,label=usage-parse2] </p>
<blockquote class="doxtable">
<p>make eval times=5</p>
<p></p>
</blockquote>
<p>{lstlisting}</p>
<p>Finally, there is a task to create plots for the evaluation. This task needs R with the package ggplot2.</p>
<p>{lstlisting}[caption=Plots,label=usage-parse2] </p>
<blockquote class="doxtable">
<p>make plots</p>
<p></p>
</blockquote>
<p>{lstlisting} </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 17 2014 00:01:12 for JNIF by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
