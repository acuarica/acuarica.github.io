---
import { CollectionEntry, getCollection } from "astro:content";
import Page from "@layouts/Page.astro";
import Tags from "@components/Tags.astro";
import ToC, { type Li, type Ul } from "@components/ToC.astro";
import type { List } from "mdast-util-toc/lib";

interface Props {
    entry: CollectionEntry<"posts">;
}

export async function getStaticPaths() {
    const blogEntries = await getCollection("posts");
    return blogEntries.map(entry => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { title, tags, date } = entry.data;
const { Content, remarkPluginFrontmatter } = await entry.render();

function getToc(list: List): Ul {
    const ul: Ul = [];
    for (const child of list.children) {
        const li: Li = { href: "", text: "" };
        for (const node of child.children) {
            if (node.type === "paragraph") {
                const link = node.children[0]!;
                if (link.type === "link") {
                    li.href = link.url;
                    const text = link.children[0]!;
                    if (text.type === "text") {
                        li.text = text.value;
                    }
                }
            } else if (node.type === "list") {
                li.children = getToc(node);
            }
        }
        ul.push(li);
    }
    return ul;
}

const toc = getToc(remarkPluginFrontmatter.toc.map);
---

<Page title={title}>
    <div class="flex lg:gap-10 justify-between">
        <article class="prose prose-lg max-w-[1024px] prose-img:mx-auto">
            <h1>{title}</h1>
            <h3>{date.toDateString()}</h3>
            <h4>{remarkPluginFrontmatter.minutesRead}</h4>
            <Tags tags={tags} />
            <div class="my-4 lg:hidden">
                <ToC toc={toc} />
            </div>
            <Content />
        </article>
        <div class="hidden lg:block">
            <ToC toc={toc} />
        </div>
    </div>
</Page>

<style is:global>
    span.icon.icon-link::after {
        content: "#";
    }

    span.icon.icon-link {
        @apply mr-2;
    }

    @media (min-width: 1024px) {
        span.icon.icon-link {
            @apply ml-[-1.25rem];
        }
    }
</style>
